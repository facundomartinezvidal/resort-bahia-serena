# üè® Flujo Completo de Usuario - Resort Bah√≠a Serena

## üìã √çndice

1. [Reserva Online](#paso-1-reserva-online)
2. [Pago de Se√±a](#paso-2-pago-de-se√±a)
3. [Check-in](#paso-3-check-in)
4. [Consumo de Servicios](#paso-4-consumo-de-servicios-adicionales)
5. [Check-out y Facturaci√≥n](#paso-5-check-out-y-facturaci√≥n)
6. [Pago Final](#paso-6-pago-final)
7. [Consultas de Verificaci√≥n](#paso-7-consultas-de-verificaci√≥n)
8. [Caso Walk-in (Sin Reserva)](#caso-especial-walk-in-sin-reserva)

---

## ‚ö†Ô∏è IMPORTANTE: Cu√°ndo se Factura

### ‚ùå NO se emite factura en:

- La creaci√≥n de la reserva
- El pago de se√±a/anticipo (solo recibo)
- El check-in

### ‚úÖ S√ç se emite factura en:

- **Check-out**: Por consumos reales durante la estad√≠a
- **Servicios puntuales**: Cliente ex## üìù Notas Importantes

1. **Soft Deletes**: Todas las tablas tienen `fecha_eliminacion` para borrado l√≥gico
2. **Trazabilidad**: Los precios se guardan en el momento de la reserva/compra
3. **Flexibilidad de Pagos**: Los pagos pueden existir antes que las facturas (se√±a)
4. **Flexibilidad de Facturas**: Las facturas pueden emitirse sin reserva (walk-ins)
5. **Referencias**: `detalle_factura` mantiene referencias a `detalle_reserva` y `reserva_servicio`
6. **Estados de Reserva**: PENDIENTE ‚Üí CONFIRMADA ‚Üí EN_CURSO ‚Üí COMPLETADA
7. **Momento de Facturaci√≥n**: La factura se emite al check-out, NO al reservar
8. **id_cliente en factura**: Permite facturar a clientes sin reserva (walk-ins)

---

## üõ†Ô∏è Ajuste Recomendado para Walk-ins

Para soportar completamente clientes walk-in, modificar la tabla `pago`:

```sql
-- Hacer id_reserva opcional
ALTER TABLE pago
ALTER COLUMN id_reserva INT NULL;

-- Agregar constraint: debe tener reserva O factura
ALTER TABLE pago
ADD CONSTRAINT CK_pago_reserva_o_factura
CHECK (id_reserva IS NOT NULL OR id_factura IS NOT NULL);
```

Esto permite:

- Pagos de se√±a sin factura: `id_reserva = 100, id_factura = NULL`
- Pagos walk-in sin reserva: `id_reserva = NULL, id_factura = 500`
- Pagos de saldo con ambos: `id_reserva = 100, id_factura = 1`

---

*Generado para Resort Bah√≠a Serena - Sistema de Gesti√≥n Hotelera*eserva (walk-in)

---

## üìÖ PASO 1: Reserva Online

**Escenario:** Juan P√©rez reserva una habitaci√≥n Suite para 3 noches (20-23 de diciembre) y contrata el servicio de Spa para 2 personas.

### 1.1. Registrar/Verificar Cliente

```sql
-- Insertar cliente nuevo
INSERT INTO cliente (nombre, apellido, dni, email, telefono, estado, fecha_nacimiento)
VALUES ('Juan', 'P√©rez', '12345678', 'juan.perez@gmail.com', '1234567890', 'ACTIVO', '1990-05-15');

-- Supongamos que obtiene id_cliente = 1
```

### 1.2. Crear Reserva

```sql
INSERT INTO reserva (id_cliente, estado_reserva, fecha_checkin, fecha_checkout)
VALUES (1, 'PENDIENTE', '2025-12-20 14:00:00', '2025-12-23 10:00:00');

-- Supongamos que obtiene id_reserva = 100
```

### 1.3. Agregar Habitaci√≥n a la Reserva

```sql
-- Buscar precio vigente de la tarifa (seg√∫n temporada y tipo de habitaci√≥n)
-- Para este ejemplo: Habitaci√≥n 201, Suite, $15,000 por noche

INSERT INTO detalle_reserva (
    id_reserva,
    id_habitacion,
    precio_noche,
    fecha_checkin,
    fecha_checkout,
    cant_noches,
    subtotal
)
VALUES (100, 201, 15000.00, '2025-12-20 14:00:00', '2025-12-23 10:00:00', 3, 45000.00);
-- Subtotal hospedaje: 15,000 √ó 3 noches = 45,000
```

### 1.4. Agregar Servicio Adicional (Spa)

```sql
INSERT INTO reserva_servicio (
    id_reserva,
    id_servicio_adicional,
    cantidad,
    precio_unitario,
    fecha_servicio,
    subtotal
)
VALUES (100, 5, 2, 8000.00, '2025-12-21 16:00:00', 16000.00);
-- 2 personas al Spa: 8,000 √ó 2 = 16,000
-- id_reserva_servicio = 1
```

**üìä Estado Actual:**

- ‚úÖ Reserva creada: `estado_reserva = 'PENDIENTE'`
- ‚úÖ Hospedaje: **$45,000** (3 noches)
- ‚úÖ Servicios: **$16,000** (Spa x2)
- üí∞ **TOTAL A PAGAR: $61,000**

---

## üí≥ PASO 2: Pago de Se√±a

**Escenario:** El cliente paga el 30% de se√±a para confirmar su reserva.

### 2.1. Registrar Pago de Se√±a

```sql
-- Se√±a del 30%: 61,000 √ó 0.30 = 18,300
INSERT INTO pago (
    id_reserva,
    id_factura,
    tipo_pago,
    metodo_pago,
    monto,
    estado,
    concepto
)
VALUES (
    100,
    NULL,  -- A√∫n no hay factura
    'SE√ëA',
    'TARJETA_CREDITO',
    18300.00,
    'APROBADO',
    'Se√±a 30% reserva Habitaci√≥n 201'
);
```

### 2.2. Confirmar Reserva

```sql
UPDATE reserva
SET estado_reserva = 'CONFIRMADA'
WHERE id_reserva = 100;
```

**üìä Estado Actual:**

- ‚úÖ Se√±a pagada: **$18,300**
- üí∞ Pendiente de pago: **$42,700**
- ‚úÖ Reserva confirmada: `estado_reserva = 'CONFIRMADA'`

---

## üö™ PASO 3: Check-in

**Fecha:** 20 de diciembre de 2025 a las 14:00 hs

### 3.1. Cambiar Estado de Reserva

```sql
UPDATE reserva
SET estado_reserva = 'EN_CURSO'
WHERE id_reserva = 100;
```

### 3.2. Actualizar Estado de Habitaci√≥n (opcional)

```sql
-- Si tienes control de estado "OCUPADA" en habitacion
UPDATE habitacion
SET estado_operativo = 'OCUPADA'
WHERE id_habitacion = 201;
```

**üìä Estado Actual:**

- ‚úÖ Cliente alojado
- ‚úÖ Reserva: `estado_reserva = 'EN_CURSO'`
- üè® Habitaci√≥n 201: Ocupada

---

## üçΩÔ∏è PASO 4: Consumo de Servicios Adicionales

**Escenario:** Durante su estad√≠a, el cliente contrata servicios adicionales.

### 4.1. Cena Especial (21 de diciembre)

```sql
INSERT INTO reserva_servicio (
    id_reserva,
    id_servicio_adicional,
    cantidad,
    precio_unitario,
    fecha_servicio,
    subtotal
)
VALUES (100, 3, 2, 5000.00, '2025-12-21 20:00:00', 10000.00);
-- Cena para 2 personas: 5,000 √ó 2 = 10,000
-- id_reserva_servicio = 2
```

### 4.2. Masaje Extra (22 de diciembre)

```sql
INSERT INTO reserva_servicio (
    id_reserva,
    id_servicio_adicional,
    cantidad,
    precio_unitario,
    fecha_servicio,
    subtotal
)
VALUES (100, 5, 1, 8000.00, '2025-12-22 15:00:00', 8000.00);
-- Masaje adicional: 8,000 √ó 1 = 8,000
-- id_reserva_servicio = 3
```

**üìä Estado Actualizado:**

- üè® Hospedaje: **$45,000**
- üíÜ Servicios totales: **$34,000** (16,000 + 10,000 + 8,000)
- üí∞ **NUEVO TOTAL: $79,000**
- ‚úÖ Ya pagado: $18,300
- ‚ö†Ô∏è **PENDIENTE: $60,700**

---

## üèÅ PASO 5: Check-out y Facturaci√≥n

**Fecha:** 23 de diciembre de 2025 a las 10:00 hs

### 5.1. Calcular Totales de la Estad√≠a

```sql
SELECT
    -- Hospedaje
    (SELECT SUM(subtotal)
     FROM detalle_reserva
     WHERE id_reserva = 100) AS total_hospedaje,

    -- Servicios
    (SELECT SUM(subtotal)
     FROM reserva_servicio
     WHERE id_reserva = 100) AS total_servicios,

    -- Total consumos
    (SELECT SUM(subtotal) FROM detalle_reserva WHERE id_reserva = 100) +
    (SELECT SUM(subtotal) FROM reserva_servicio WHERE id_reserva = 100) AS total_consumos,

    -- Ya pagado
    (SELECT COALESCE(SUM(monto), 0)
     FROM pago
     WHERE id_reserva = 100 AND estado = 'APROBADO') AS total_pagado,

    -- Saldo pendiente
    ((SELECT SUM(subtotal) FROM detalle_reserva WHERE id_reserva = 100) +
     (SELECT SUM(subtotal) FROM reserva_servicio WHERE id_reserva = 100)) -
    (SELECT COALESCE(SUM(monto), 0) FROM pago WHERE id_reserva = 100 AND estado = 'APROBADO') AS saldo_pendiente;
```

**üìä Resultado:**
| Concepto | Monto |
|----------|-------|
| Total Hospedaje | $45,000 |
| Total Servicios | $34,000 |
| **Total Consumos** | **$79,000** |
| Ya Pagado | $18,300 |
| **Saldo Pendiente** | **$60,700** |

### 5.2. Generar Factura Final

#### 5.2.1. Crear Factura

```sql
-- C√°lculo de impuestos (ejemplo: IVA 8%)
-- Subtotal sin impuestos: 79,000 / 1.08 = 73,148.15
-- Impuestos: 79,000 - 73,148.15 = 5,851.85

INSERT INTO factura (
    id_cliente,
    id_reserva,
    numero_factura,
    tipo_comprobante,
    concepto,
    subtotal,
    impuestos,
    total,
    estado
)
VALUES (
    1,
    100,
    'F-2025-00001',
    'FACTURA',
    'Estad√≠a Habitaci√≥n 201 del 20 al 23 de diciembre',
    73148.15,
    5851.85,
    79000.00,
    'EMITIDA'
);
-- Supongamos id_factura = 1
```

#### 5.2.2. Detallar Hospedaje en Factura

```sql
INSERT INTO detalle_factura (
    id_factura,
    concepto,
    cantidad,
    precio_unitario,
    subtotal,
    id_detalle_reserva
)
VALUES (
    1,
    'Habitaci√≥n Suite Vista Mar - 3 noches',
    3,
    15000.00,
    45000.00,
    1  -- Referencia al detalle_reserva
);
```

#### 5.2.3. Detallar Servicios en Factura

```sql
-- Spa inicial (2 personas)
INSERT INTO detalle_factura (
    id_factura, concepto, cantidad, precio_unitario, subtotal, id_reserva_servicio
)
VALUES (1, 'Spa - Masaje relajante (2 personas)', 2, 8000.00, 16000.00, 1);

-- Cena especial
INSERT INTO detalle_factura (
    id_factura, concepto, cantidad, precio_unitario, subtotal, id_reserva_servicio
)
VALUES (1, 'Cena Tem√°tica (2 personas)', 2, 5000.00, 10000.00, 2);

-- Masaje adicional
INSERT INTO detalle_factura (
    id_factura, concepto, cantidad, precio_unitario, subtotal, id_reserva_servicio
)
VALUES (1, 'Spa - Masaje relajante (1 persona)', 1, 8000.00, 8000.00, 3);
```

---

## üí∞ PASO 6: Pago Final

### 6.1. Registrar Pago del Saldo

```sql
INSERT INTO pago (
    id_reserva,
    id_factura,
    tipo_pago,
    metodo_pago,
    monto,
    estado,
    concepto
)
VALUES (
    100,
    1,
    'SALDO',
    'TARJETA_CREDITO',
    60700.00,
    'APROBADO',
    'Pago saldo check-out'
);
```

### 6.2. Vincular Se√±a con Factura

```sql
-- Actualizar el pago de se√±a para vincularlo a la factura emitida
UPDATE pago
SET id_factura = 1
WHERE id_reserva = 100 AND tipo_pago = 'SE√ëA';
```

### 6.3. Completar Reserva

```sql
-- Cambiar estado a COMPLETADA
UPDATE reserva
SET estado_reserva = 'COMPLETADA'
WHERE id_reserva = 100;

-- Liberar habitaci√≥n
UPDATE habitacion
SET estado_operativo = 'DISPONIBLE'
WHERE id_habitacion = 201;
```

**üìä Estado Final:**

- ‚úÖ Factura emitida: **F-2025-00001**
- ‚úÖ Total facturado: **$79,000**
- ‚úÖ Se√±a: **$18,300**
- ‚úÖ Saldo: **$60,700**
- üíö **PAGADO COMPLETO: $79,000**
- ‚úÖ Reserva: `estado_reserva = 'COMPLETADA'`
- ‚úÖ Habitaci√≥n: `estado_operativo = 'DISPONIBLE'`

---

## üìä PASO 7: Consultas de Verificaci√≥n

### 7.1. Ver Factura Completa

```sql
SELECT
    f.numero_factura,
    f.fecha_emision,
    c.nombre + ' ' + c.apellido AS cliente,
    c.dni,
    c.email,
    df.concepto,
    df.cantidad,
    df.precio_unitario,
    df.subtotal,
    f.subtotal AS factura_subtotal,
    f.impuestos AS factura_impuestos,
    f.total AS factura_total
FROM factura f
JOIN cliente c ON f.id_cliente = c.id_cliente
JOIN detalle_factura df ON f.id_factura = df.id_factura
WHERE f.id_factura = 1
ORDER BY df.id_detalle_factura;
```

**Resultado esperado:**

| numero_factura | cliente    | concepto                              | cantidad | precio_unitario | subtotal  |
| -------------- | ---------- | ------------------------------------- | -------- | --------------- | --------- |
| F-2025-00001   | Juan P√©rez | Habitaci√≥n Suite Vista Mar - 3 noches | 3        | 15,000.00       | 45,000.00 |
| F-2025-00001   | Juan P√©rez | Spa - Masaje relajante (2 personas)   | 2        | 8,000.00        | 16,000.00 |
| F-2025-00001   | Juan P√©rez | Cena Tem√°tica (2 personas)            | 2        | 5,000.00        | 10,000.00 |
| F-2025-00001   | Juan P√©rez | Spa - Masaje relajante (1 persona)    | 1        | 8,000.00        | 8,000.00  |

**Totales:**

- Subtotal sin IVA: $73,148.15
- IVA (8%): $5,851.85
- **TOTAL: $79,000.00**

### 7.2. Ver Historial de Pagos

```sql
SELECT
    p.tipo_pago,
    p.metodo_pago,
    p.monto,
    p.concepto,
    p.fecha_pago,
    p.estado,
    CASE
        WHEN p.id_factura IS NULL THEN 'Sin vincular'
        ELSE f.numero_factura
    END AS factura_asociada
FROM pago p
LEFT JOIN factura f ON p.id_factura = f.id_factura
WHERE p.id_reserva = 100 AND p.estado = 'APROBADO'
ORDER BY p.fecha_pago;
```

**Resultado esperado:**

| tipo_pago | metodo_pago     | monto     | concepto                        | fecha_pago          | factura_asociada |
| --------- | --------------- | --------- | ------------------------------- | ------------------- | ---------------- |
| SE√ëA      | TARJETA_CREDITO | 18,300.00 | Se√±a 30% reserva Habitaci√≥n 201 | 2025-11-15 10:30:00 | F-2025-00001     |
| SALDO     | TARJETA_CREDITO | 60,700.00 | Pago saldo check-out            | 2025-12-23 10:15:00 | F-2025-00001     |

**TOTAL PAGADO: $79,000.00** ‚úÖ

### 7.3. Verificar Saldo de Factura

```sql
SELECT
    f.numero_factura,
    f.total AS total_factura,
    COALESCE(SUM(p.monto), 0) AS total_pagado,
    f.total - COALESCE(SUM(p.monto), 0) AS saldo_pendiente,
    CASE
        WHEN f.total - COALESCE(SUM(p.monto), 0) = 0 THEN '‚úÖ PAGADO'
        WHEN f.total - COALESCE(SUM(p.monto), 0) > 0 THEN '‚ö†Ô∏è PENDIENTE'
        ELSE '‚ùå ERROR'
    END AS estado_pago
FROM factura f
LEFT JOIN pago p ON f.id_factura = p.id_factura AND p.estado = 'APROBADO'
WHERE f.id_factura = 1
GROUP BY f.numero_factura, f.total;
```

**Resultado esperado:**

| numero_factura | total_factura | total_pagado | saldo_pendiente | estado_pago |
| -------------- | ------------- | ------------ | --------------- | ----------- |
| F-2025-00001   | 79,000.00     | 79,000.00    | 0.00            | ‚úÖ PAGADO   |

### 7.4. Resumen de la Reserva

```sql
SELECT
    r.id_reserva,
    c.nombre + ' ' + c.apellido AS cliente,
    r.estado_reserva,
    r.fecha_checkin,
    r.fecha_checkout,
    -- Hospedaje
    (SELECT SUM(dr.subtotal) FROM detalle_reserva dr WHERE dr.id_reserva = r.id_reserva) AS total_hospedaje,
    -- Servicios
    (SELECT SUM(rs.subtotal) FROM reserva_servicio rs WHERE rs.id_reserva = r.id_reserva) AS total_servicios,
    -- Total
    (SELECT SUM(dr.subtotal) FROM detalle_reserva dr WHERE dr.id_reserva = r.id_reserva) +
    (SELECT SUM(rs.subtotal) FROM reserva_servicio rs WHERE rs.id_reserva = r.id_reserva) AS total_reserva,
    -- Factura
    (SELECT numero_factura FROM factura WHERE id_reserva = r.id_reserva) AS numero_factura,
    -- Pagos
    (SELECT COALESCE(SUM(monto), 0) FROM pago WHERE id_reserva = r.id_reserva AND estado = 'APROBADO') AS total_pagado
FROM reserva r
JOIN cliente c ON r.id_cliente = c.id_cliente
WHERE r.id_reserva = 100;
```

**Resultado esperado:**

| id_reserva | cliente    | estado_reserva | fecha_checkin    | fecha_checkout   | total_hospedaje | total_servicios | total_reserva | numero_factura | total_pagado |
| ---------- | ---------- | -------------- | ---------------- | ---------------- | --------------- | --------------- | ------------- | -------------- | ------------ |
| 100        | Juan P√©rez | COMPLETADA     | 2025-12-20 14:00 | 2025-12-23 10:00 | 45,000.00       | 34,000.00       | 79,000.00     | F-2025-00001   | 79,000.00    |

---

## üìà Diagrama de Flujo Simplificado

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. RESERVA     ‚îÇ  ‚Üí estado_reserva: 'PENDIENTE'
‚îÇ  Online         ‚îÇ     Total: $79,000
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. PAGO SE√ëA   ‚îÇ  ‚Üí estado_reserva: 'CONFIRMADA'
‚îÇ  30% = $18,300  ‚îÇ     Pendiente: $60,700
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. CHECK-IN    ‚îÇ  ‚Üí estado_reserva: 'EN_CURSO'
‚îÇ  20/12 14:00    ‚îÇ     habitacion: 'OCUPADA'
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  4. SERVICIOS   ‚îÇ  ‚Üí Cena: $10,000
‚îÇ  Adicionales    ‚îÇ     Masaje: $8,000
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     NUEVO TOTAL: $79,000
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  5. CHECK-OUT   ‚îÇ  ‚Üí Genera FACTURA
‚îÇ  23/12 10:00    ‚îÇ     F-2025-00001
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  6. PAGO SALDO  ‚îÇ  ‚Üí Paga $60,700
‚îÇ  $60,700        ‚îÇ     Total pagado: $79,000 ‚úÖ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  7. FINALIZA    ‚îÇ  ‚Üí estado_reserva: 'COMPLETADA'
‚îÇ  Reserva        ‚îÇ     habitacion: 'DISPONIBLE'
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ Resumen Final

| Concepto                  | Valor                  |
| ------------------------- | ---------------------- |
| **Hospedaje (3 noches)**  | $45,000                |
| **Servicios adicionales** | $34,000                |
| **Total**                 | **$79,000**            |
| Se√±a (30%)                | $18,300 ‚úÖ             |
| Saldo final               | $60,700 ‚úÖ             |
| **Estado**                | **PAGADO COMPLETO** ‚úÖ |

---

## ÔøΩ CASO ESPECIAL: Walk-in (Sin Reserva)

**Escenario:** Cliente externo usa servicios del hotel sin estar alojado.

### Ejemplo 1: Cena en el Restaurant

```sql
-- 1. Verificar/crear cliente
INSERT INTO cliente (nombre, apellido, dni, email, telefono, estado, fecha_nacimiento)
VALUES ('Mar√≠a', 'Gonz√°lez', '87654321', 'maria.gonzalez@gmail.com', '0987654321', 'ACTIVO', '1985-03-10');
-- id_cliente = 50

-- 2. NO hay reserva, consumo directo
-- El cliente NO necesita reserva para consumir

-- 3. Registrar servicio consumido (opcional, para trazabilidad)
-- Si quer√©s trackear: crear reserva "virtual" solo para servicios
-- O simplemente registrar en la factura directamente

-- 4. Emitir factura INMEDIATA (al momento del consumo)
INSERT INTO factura (
    id_cliente,     -- ‚úÖ Tiene cliente
    id_reserva,     -- ‚ùå NULL - No tiene reserva
    numero_factura,
    tipo_comprobante,
    concepto,
    subtotal,
    impuestos,
    total,
    estado
)
VALUES (
    50,             -- Cliente walk-in
    NULL,           -- Sin reserva
    'F-2025-00500',
    'FACTURA',
    'Consumo restaurant',
    9259.26,        -- Sin IVA
    740.74,         -- IVA 8%
    10000.00,
    'EMITIDA'
);
-- id_factura = 500

-- 5. Detallar items de la factura
INSERT INTO detalle_factura (
    id_factura,
    concepto,
    cantidad,
    precio_unitario,
    subtotal,
    id_detalle_reserva,      -- NULL
    id_reserva_servicio      -- NULL o referencia si registraste
)
VALUES
(500, 'Cena para 2 personas', 2, 5000.00, 10000.00, NULL, NULL);

-- 6. Registrar pago INMEDIATO
-- PROBLEMA: La tabla pago requiere id_reserva
-- SOLUCI√ìN: Crear reserva "virtual" o modificar tabla pago
```

### üîß Ajuste Necesario para Walk-ins

**Actualmente tu tabla `pago` requiere `id_reserva`:**

```sql
CREATE TABLE pago(
    id_reserva INT,  -- ‚ö†Ô∏è NOT NULL impl√≠cito por FK
    ...
);
```

**Opciones para soportar walk-ins:**

#### Opci√≥n A: Hacer `id_reserva` opcional (Recomendado ‚úÖ)

```sql
CREATE TABLE pago(
    id_pago INT PRIMARY KEY IDENTITY (1,1),
    id_reserva INT NULL,        -- ‚úÖ Ahora puede ser NULL
    id_factura INT NULL,
    ...
    FOREIGN KEY (id_reserva) REFERENCES reserva(id_reserva),
    FOREIGN KEY (id_factura) REFERENCES factura(id_factura)
);

-- Registrar pago walk-in
INSERT INTO pago (
    id_reserva,     -- NULL (no hay reserva)
    id_factura,     -- Factura walk-in
    tipo_pago,      -- 'CONSUMO'
    metodo_pago,
    monto,
    estado,
    concepto
)
VALUES (NULL, 500, 'CONSUMO', 'TARJETA_CREDITO', 10000.00, 'APROBADO', 'Pago cena restaurant');
```

#### Opci√≥n B: Vincular pago solo a factura

```sql
-- Cambiar l√≥gica: el pago puede vincular a reserva O a factura (al menos uno)
ALTER TABLE pago ADD CHECK (id_reserva IS NOT NULL OR id_factura IS NOT NULL);
```

### Flujo Walk-in Completo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Cliente llega      ‚îÇ
‚îÇ  sin reserva        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Consume servicio   ‚îÇ  (Restaurant, Spa, etc.)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Emite FACTURA      ‚îÇ  id_cliente: ‚úÖ
‚îÇ  inmediatamente     ‚îÇ  id_reserva: NULL
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Paga y se va       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä Comparaci√≥n: Hu√©sped vs Walk-in

| Aspecto                   | Hu√©sped Alojado        | Cliente Walk-in         |
| ------------------------- | ---------------------- | ----------------------- |
| **Tiene reserva**         | ‚úÖ S√≠                  | ‚ùå No                   |
| **Cu√°ndo factura**        | Al check-out           | Inmediatamente          |
| **factura.id_reserva**    | ‚úÖ Tiene valor         | ‚ùå NULL                 |
| **factura.id_cliente**    | ‚úÖ Requerido           | ‚úÖ Requerido            |
| **Permite se√±a/anticipo** | ‚úÖ S√≠                  | ‚ùå No (pago inmediato)  |
| **Puede pagar despu√©s**   | ‚úÖ S√≠ (cuenta abierta) | ‚ùå No (pago al momento) |

---

## üîë Por qu√© `factura` tiene `id_cliente` e `id_reserva`

```sql
CREATE TABLE factura(
    id_cliente INT NOT NULL,    -- ‚úÖ Siempre hay cliente
    id_reserva INT NULL,        -- ‚úÖ Puede no haber reserva
    ...
);
```

### Beneficios del dise√±o:

1. **Flexibilidad**: Soporta hu√©spedes Y walk-ins
2. **Performance**: Acceso directo a datos del cliente sin JOIN
3. **Integridad**: Garantiza que toda factura tenga un cliente responsable
4. **Trazabilidad**: Relaciona factura con reserva cuando existe

### Ejemplos de queries:

```sql
-- Todas las facturas de un cliente (con o sin reserva)
SELECT * FROM factura WHERE id_cliente = 1;

-- Facturas de walk-ins (sin reserva)
SELECT * FROM factura WHERE id_reserva IS NULL;

-- Facturas de una reserva espec√≠fica
SELECT * FROM factura WHERE id_reserva = 100;

-- Historial completo de un cliente
SELECT
    f.numero_factura,
    f.fecha_emision,
    f.total,
    CASE
        WHEN f.id_reserva IS NOT NULL THEN 'Estad√≠a'
        ELSE 'Walk-in'
    END AS tipo_consumo
FROM factura f
WHERE f.id_cliente = 1;
```

---

## ÔøΩüìù Notas Importantes

1. **Soft Deletes**: Todas las tablas tienen `fecha_eliminacion` para borrado l√≥gico
2. **Trazabilidad**: Los precios se guardan en el momento de la reserva/compra
3. **Flexibilidad**: Los pagos pueden existir antes que las facturas (se√±a)
4. **Referencias**: `detalle_factura` mantiene referencias a `detalle_reserva` y `reserva_servicio`
5. **Estados**: La reserva pasa por: PENDIENTE ‚Üí CONFIRMADA ‚Üí EN_CURSO ‚Üí COMPLETADA

---

_Generado para Resort Bah√≠a Serena - Sistema de Gesti√≥n Hotelera_
